<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Referral - Place Psychology</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Custom fonts */
        @font-face {
            font-family: 'Gellix';
            src: url('../fonts/Gellix%20Regular-e053.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Gambarino';
            src: url('../fonts/Gambarino-Regular.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'Gellix', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5e7cc; /* Place Cream */
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            color: #3f1908; /* Place Burnt */
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(63, 25, 8, 0.15);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, #ecd099 0%, #d66f2a 100%); /* Place Gold to Place Ochre */
            color: white;
            padding: 50px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        /* Subtle texture overlay */
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.1;
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.1) 35px, rgba(255,255,255,.1) 70px);
        }

        .logo {
            width: 120px;
            height: auto;
            margin-bottom: 20px;
        }

        .header h1 {
            font-family: 'Gambarino', serif;
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: normal;
            letter-spacing: 0.5px;
            position: relative;
            z-index: 1;
        }

        .header p {
            opacity: 0.95;
            font-size: 16px;
            font-weight: normal;
            position: relative;
            z-index: 1;
        }

        .form-container {
            padding: 40px 30px;
            background: white;
        }

        /* Privacy Notice Styling - Matches your existing design */
        .privacy-notice {
            background: linear-gradient(135deg, #f5e7cc 0%, #ecd099 30%);
            border-left: 4px solid #d66f2a;
            padding: 20px 25px;
            margin: -20px -30px 30px -30px;
            font-size: 14px;
            line-height: 1.6;
            color: #3f1908;
            position: relative;
        }

        .privacy-notice strong {
            color: #c95a28;
            font-weight: normal;
            font-family: 'Gambarino', serif;
            font-size: 16px;
            letter-spacing: 0.3px;
        }

        .section {
            margin-bottom: 40px;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        .section:nth-child(1) { animation-delay: 0.1s; }
        .section:nth-child(2) { animation-delay: 0.2s; }
        .section:nth-child(3) { animation-delay: 0.3s; }
        .section:nth-child(4) { animation-delay: 0.4s; }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
            from {
                opacity: 0;
                transform: translateY(20px);
            }
        }

        .section-title {
            font-family: 'Gambarino', serif;
            font-size: 20px;
            color: #c95a28; /* Place Rust */
            margin-bottom: 20px;
            font-weight: normal;
            display: flex;
            align-items: center;
            letter-spacing: 0.3px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(to bottom, #d66f2a, #ecd099);
            margin-right: 12px;
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #3f1908;
            font-weight: normal;
            font-size: 14px;
            letter-spacing: 0.2px;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="month"],
        textarea,
        select {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #ecd099;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fefefe;
            color: #3f1908;
            font-family: 'Gellix', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        input::placeholder {
            color: #999;
            font-size: 15px;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #d66f2a;
            background: white;
            box-shadow: 0 0 0 4px rgba(214, 111, 42, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-upload input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-upload-label {
            display: block;
            padding: 16px 20px;
            background: linear-gradient(135deg, #f5e7cc 0%, #ecd099 100%);
            border: 2px dashed #d66f2a;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
            color: #c95a28;
            font-weight: normal;
        }

        .file-upload-label:hover {
            background: linear-gradient(135deg, #ecd099 0%, #f5e7cc 100%);
            border-color: #c95a28;
            transform: translateY(-2px);
        }

        .file-list {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        .file-item {
            background: #f5e7cc;
            padding: 10px 14px;
            border-radius: 8px;
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #ecd099;
        }

        .remove-file {
            color: #c95a28;
            cursor: pointer;
            font-size: 12px;
            font-weight: normal;
            transition: color 0.2s ease;
        }

        .remove-file:hover {
            color: #d66f2a;
        }

        .submit-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #c95a28 0%, #d66f2a 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: normal;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.3px;
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(201, 90, 40, 0.3);
        }

        .submit-button:active {
            transform: translateY(0);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 60px;
        }

        .spinner {
            border: 3px solid #ecd099;
            border-top: 3px solid #d66f2a;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-container {
            display: none;
            text-align: center;
            padding: 60px 30px;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: #a9d0c6; /* Place Aqua */
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: successPop 0.5s ease;
        }

        @keyframes successPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .success-icon::after {
            content: '‚úì';
            color: white;
            font-size: 40px;
            font-weight: bold;
        }

        .success-title {
            font-family: 'Gambarino', serif;
            font-size: 28px;
            color: #3f1908;
            margin-bottom: 10px;
            font-weight: normal;
        }

        .success-message {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
            line-height: 1.6;
        }

        .practice-link {
            display: inline-block;
            padding: 14px 32px;
            background: linear-gradient(135deg, #c95a28 0%, #d66f2a 100%);
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-weight: normal;
            transition: all 0.3s ease;
            letter-spacing: 0.3px;
        }

        .practice-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(201, 90, 40, 0.3);
        }

        .error {
            color: #c95a28;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .error-container {
            margin: 20px 0;
            animation: fadeIn 0.3s ease;
        }

        .error-box {
            background: white;
            border: 2px solid #c95a28;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(201, 90, 40, 0.15);
        }

        .contact-box {
            background: #f5e7cc;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .retry-button, .report-button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .retry-button:hover, .report-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Service Timeline Styles */
        .service-timeline {
            margin: 30px 0;
            padding: 0 20px;
        }

        .timeline-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .timeline-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 30px;
            position: relative;
            padding-left: 0;
        }

        .timeline-item:not(:last-child) {
            padding-bottom: 20px;
            border-left: 2px solid #ecd099;
            margin-left: 24px;
        }

        .timeline-badge {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #d66f2a;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            margin-right: 20px;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }

        .timeline-content {
            flex: 1;
            padding-top: 5px;
        }

        .timeline-content h4 {
            margin: 0 0 12px 0;
            color: #3f1908;
            font-size: 18px;
            font-weight: bold;
        }

        .timeline-content ul {
            margin: 0;
            padding-left: 20px;
            color: #666;
            font-size: 15px;
            line-height: 1.8;
        }

        .timeline-content li {
            margin-bottom: 5px;
        }

        .no-waitlist-banner {
            background: linear-gradient(135deg, #f5e7cc 0%, #ecd099 100%);
            border: 2px solid #d66f2a;
            border-radius: 12px;
            padding: 25px;
            margin: 40px 0;
            text-align: center;
        }

        .no-waitlist-banner strong {
            color: #c95a28;
            font-size: 20px;
        }

        .no-waitlist-banner p {
            margin: 0;
            color: #3f1908;
            font-size: 16px;
            line-height: 1.5;
        }

        /* Hidden verification field */
        .form-verify {
            position: absolute;
            left: -9999px;
            top: -9999px;
            height: 0;
            width: 0;
            z-index: -1;
            overflow: hidden;
            opacity: 0;
        }

        /* Responsive design */
        @media (max-width: 640px) {
            .container {
                margin: 0;
                border-radius: 20px;
            }
            
            .header {
                padding: 40px 20px;
            }
            
            .form-container {
                padding: 30px 20px;
            }

            .header h1 {
                font-size: 28px;
            }

            .privacy-notice {
                margin: -15px -20px 25px -20px;
                padding: 18px 20px 18px 20px;
                font-size: 13px;
            }
            
            /* Stack location options on mobile */
            div[style*="display: flex; gap: 20px"] {
                flex-direction: column !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <!-- Place Psychology Logo -->
            <img src="../place-logo.png" alt="Place Psychology" class="logo">
            <h1>Patient Referral Form</h1>
            <p>Secure Referral to Place Psychology</p>
        </div>

        <form id="referralForm" class="form-container">
            <!-- Verification field -->
            <div class="form-verify" aria-hidden="true">
                <input type="text" name="ref_verify" id="ref_verify" tabindex="-1" autocomplete="off">
            </div>

            <!-- Privacy Notice -->
            <div class="privacy-notice">
                <strong style="display: block; margin-left: -2px;">üîí Privacy & Security</strong>
                This form is secure and all patient information is handled in accordance with Australian privacy laws. By submitting this referral, you confirm that you have the patient's consent to share their information for the purpose of mental health treatment.
            </div>

            <!-- Location Selection -->
            <div class="section">
                <h2 class="section-title">Select Practice Location</h2>
                
                <div class="form-group">
                    <label>Which Place Psychology location is this referral for? *</label>
                    <div style="display: flex; gap: 20px; margin-top: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer; padding: 16px 24px; border: 2px solid #ecd099; border-radius: 12px; flex: 1; transition: all 0.3s ease;">
                            <input type="radio" name="location" value="dapto" required style="margin-right: 10px; width: auto;">
                            <span style="font-size: 16px; font-weight: normal; color: #3f1908;">Dapto Clinic</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; padding: 16px 24px; border: 2px solid #ecd099; border-radius: 12px; flex: 1; transition: all 0.3s ease;">
                            <input type="radio" name="location" value="coledale" required style="margin-right: 10px; width: auto;">
                            <span style="font-size: 16px; font-weight: normal; color: #3f1908;">Coledale Clinic</span>
                        </label>
                    </div>
                    <span class="error">Please select a practice location</span>
                </div>
            </div>

            <!-- Referring Doctor Information -->
            <div class="section">
                <h2 class="section-title">Referring Doctor Details</h2>
                
                <div class="form-group">
                    <label for="doctorName">Your Name *</label>
                    <input type="text" id="doctorName" name="doctorName" required>
                    <span class="error">Please enter your name</span>
                </div>

                <div class="form-group">
                    <label for="doctorPractice">Practice Name *</label>
                    <input type="text" id="doctorPractice" name="doctorPractice" required>
                    <span class="error">Please enter practice name</span>
                </div>

                <div class="form-group">
                    <label for="doctorEmail">Your Email *</label>
                    <input type="email" id="doctorEmail" name="doctorEmail" required>
                    <span class="error">Please enter a valid email address</span>
                </div>

                <div class="form-group">
                    <label for="doctorPhone">Your Phone *</label>
                    <input type="tel" id="doctorPhone" name="doctorPhone" placeholder="0400 000 000" required>
                    <span class="error">Please enter a valid phone number</span>
                </div>
            </div>

            <!-- Patient Information -->
            <div class="section">
                <h2 class="section-title">Patient Information</h2>
                
                <div class="form-group">
                    <label for="patientName">Patient Name *</label>
                    <input type="text" id="patientName" name="patientName" required>
                    <span class="error">Please enter patient name</span>
                </div>

                <div class="form-group">
                    <label for="patientDOB">Date of Birth *</label>
                    <input type="text" id="patientDOB" name="patientDOB" 
                           placeholder="DD/MM/YYYY" 
                           maxlength="10"
                           pattern="\d{2}/\d{2}/\d{4}"
                           required>
                    <span class="error">Please enter date of birth as DD/MM/YYYY</span>
                </div>

                <div class="form-group">
                    <label for="patientPhone">Patient Phone *</label>
                    <input type="tel" id="patientPhone" name="patientPhone" placeholder="0400 000 000" required>
                    <span class="error">Please enter a valid phone number</span>
                </div>

                <div class="form-group">
                    <label for="patientEmail">Patient Email *</label>
                    <input type="email" id="patientEmail" name="patientEmail" required>
                    <span class="error">Please enter a valid email address</span>
                </div>

                <div class="form-group">
                    <label for="medicareNumber">Medicare Number *</label>
                    <input type="text" id="medicareNumber" name="medicareNumber" 
                           placeholder="1234 56789 0" 
                           maxlength="12" 
                           required>
                    <span class="error">Please enter a valid Medicare number</span>
                </div>

                <div class="form-group">
                    <label for="medicarePosition">Position on Card *</label>
                    <select id="medicarePosition" name="medicarePosition" required>
                        <option value="">Select position</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                    <span class="error">Please select position on card</span>
                </div>

                <div class="form-group">
                    <label for="medicareExpiry">Medicare Card Expiry *</label>
                    <input type="text" id="medicareExpiry" name="medicareExpiry" 
                           placeholder="MM/YYYY" 
                           maxlength="7"
                           pattern="\d{2}/\d{4}"
                           required>
                    <span class="error">Please enter expiry date as MM/YYYY</span>
                </div>
            </div>

            <!-- Referral Details -->
            <div class="section">
                <h2 class="section-title">Referral Details</h2>
                
                <div class="form-group">
                    <label for="referralReason">Referral Reason & Relevant Notes *</label>
                    <textarea id="referralReason" name="referralReason" 
                              placeholder="Please include presenting concerns, relevant history, and any specific treatment considerations..." 
                              required></textarea>
                    <span class="error">Please provide referral details</span>
                </div>

                <div class="form-group">
                    <label>Upload Documents (Optional)</label>
                    <div class="file-upload">
                        <input type="file" id="fileUpload" name="files" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                        <label for="fileUpload" class="file-upload-label">
                            üìé Click to upload Referral Letter and Mental Health Care Plan
                        </label>
                    </div>
                    <div id="fileList" class="file-list"></div>
                </div>
            </div>

            <button type="submit" class="submit-button">Submit Referral</button>
            
            <!-- Test Mode for Admins -->
            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px dashed #ecd099;">
                <details>
                    <summary style="cursor: pointer; color: #999; font-size: 14px;">üîß Admin Test Mode</summary>
                    <div style="margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                        <p style="font-size: 14px; margin-bottom: 10px;">Test the form connection without submitting real data:</p>
                        <button type="button" onclick="testConnection()" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Test Connection
                        </button>
                        <div id="testResult" style="margin-top: 10px; font-size: 14px;"></div>
                    </div>
                </details>
            </div>
        </form>

        <div class="loading">
            <div class="spinner"></div>
            <p>Submitting your referral...</p>
        </div>

        <div class="success-container">
            <div class="success-icon"></div>
            <h2 class="success-title">Referral Received!</h2>
            <p class="success-message">
                Thank you for referring your patient to Place Psychology. We will contact them within 24-48 hours to arrange an appointment.
                <br><br>
                You will receive a confirmation email shortly.
            </p>
            
            <!-- Service Promise Timeline -->
            <div class="service-timeline">
                <h3 style="color: #c95a28; margin: 30px 0 20px; font-size: 20px; text-align: center;">What Happens Next:</h3>
                
                <div class="timeline-container">
                    <div class="timeline-item">
                        <div class="timeline-badge" style="background: #a9d0c6;">‚úì</div>
                        <div class="timeline-content">
                            <h4>Within 2 Hours</h4>
                            <ul>
                                <li>Automated confirmation email sent to your practice</li>
                                <li>Patient added to our priority booking system</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-badge" style="background: #ecd099;">24h</div>
                        <div class="timeline-content">
                            <h4>Within 24 Hours</h4>
                            <ul>
                                <li>Patient contacted by phone (3 attempts)</li>
                                <li>Appointment scheduled</li>
                                <li>Confirmation sent to you</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-badge" style="background: #d66f2a;">7d</div>
                        <div class="timeline-content">
                            <h4>Within 7 Days</h4>
                            <ul>
                                <li>Initial appointment completed</li>
                                <li>Comprehensive intake report sent</li>
                                <li>Treatment plan communicated</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="no-waitlist-banner">
                <div style="font-size: 20px; margin-bottom: 8px;">üéØ <strong>No Waitlists, No Delays</strong></div>
                <p>Unlike many services, we maintain capacity for new referrals. Your patient will be seen within days, not weeks.</p>
            </div>
            
            <div style="margin: 30px 0; padding: 20px; background: #f5e7cc; border-radius: 12px; text-align: center;">
                <p style="margin: 0; font-size: 16px;"><strong>Direct GP Support Line:</strong> 02 4210 5206<br>
                <em style="font-size: 14px; color: #666;">For urgent consultations or complex cases</em></p>
            </div>
            
            <a href="https://placepsychology.com.au" class="practice-link" target="_blank">
                Learn More About Our Practice
            </a>
        </div>
    </div>

    <script>
        // Verification check function
        function verifySubmission() {
            const verifyField = document.getElementById('ref_verify');
            return verifyField && verifyField.value !== '';
        }

        // Handle location selection styling
        document.querySelectorAll('input[name="location"]').forEach(radio => {
            radio.addEventListener('change', function() {
                // Reset all location labels
                document.querySelectorAll('input[name="location"]').forEach(r => {
                    r.parentElement.style.borderColor = '#ecd099';
                    r.parentElement.style.background = 'white';
                });
                // Style selected
                if (this.checked) {
                    this.parentElement.style.borderColor = '#d66f2a';
                    this.parentElement.style.background = 'linear-gradient(135deg, #f5e7cc 0%, #ecd099 30%)';
                }
            });
        });

        // Date of birth formatting
        document.getElementById('patientDOB').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
            let formatted = '';
            
            if (value.length > 0) {
                // Format as DD/MM/YYYY
                if (value.length <= 2) {
                    formatted = value;
                } else if (value.length <= 4) {
                    formatted = value.slice(0, 2) + '/' + value.slice(2);
                } else {
                    formatted = value.slice(0, 2) + '/' + value.slice(2, 4) + '/' + value.slice(4, 8);
                }
            }
            
            e.target.value = formatted;
            
            // Validate date
            if (formatted.length === 10) {
                const parts = formatted.split('/');
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]);
                const year = parseInt(parts[2]);
                
                const errorSpan = e.target.parentElement.querySelector('.error');
                
                // Basic validation
                if (day < 1 || day > 31) {
                    errorSpan.textContent = 'Day must be between 1 and 31';
                    errorSpan.style.display = 'block';
                } else if (month < 1 || month > 12) {
                    errorSpan.textContent = 'Month must be between 1 and 12';
                    errorSpan.style.display = 'block';
                } else if (year < 1900 || year > new Date().getFullYear()) {
                    errorSpan.textContent = 'Please enter a valid year';
                    errorSpan.style.display = 'block';
                } else {
                    errorSpan.style.display = 'none';
                }
            }
        });

        // Medicare number formatting
        document.getElementById('medicareNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '');
            let formatted = '';
            
            if (value.length > 0) {
                // Format as: 1234 56789 0
                if (value.length <= 4) {
                    formatted = value;
                } else if (value.length <= 9) {
                    formatted = value.slice(0, 4) + ' ' + value.slice(4);
                } else {
                    formatted = value.slice(0, 4) + ' ' + value.slice(4, 9) + ' ' + value.slice(9, 10);
                }
            }
            
            e.target.value = formatted;
        });

        // Medicare expiry formatting
        document.getElementById('medicareExpiry').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
            let formatted = '';
            
            if (value.length > 0) {
                // Format as MM/YYYY
                if (value.length <= 2) {
                    formatted = value;
                } else {
                    formatted = value.slice(0, 2) + '/' + value.slice(2, 6);
                }
            }
            
            e.target.value = formatted;
            
            // Validate expiry
            if (formatted.length === 7) {
                const parts = formatted.split('/');
                const month = parseInt(parts[0]);
                const year = parseInt(parts[1]);
                
                const errorSpan = e.target.parentElement.querySelector('.error');
                
                if (month < 1 || month > 12) {
                    errorSpan.textContent = 'Month must be between 1 and 12';
                    errorSpan.style.display = 'block';
                } else {
                    // Check if expired
                    const currentDate = new Date();
                    const expiryDate = new Date(year, month - 1);
                    
                    if (expiryDate < currentDate) {
                        errorSpan.textContent = 'Medicare card appears to be expired';
                        errorSpan.style.display = 'block';
                    } else {
                        errorSpan.style.display = 'none';
                    }
                }
            }
        });

        // File upload handling
        const fileInput = document.getElementById('fileUpload');
        const fileList = document.getElementById('fileList');
        let uploadedFiles = [];

        fileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            
            files.forEach(file => {
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    alert(`${file.name} is too large. Maximum file size is 10MB.`);
                    return;
                }
                
                uploadedFiles.push(file);
                displayFiles();
            });
        });

        function displayFiles() {
            fileList.innerHTML = '';
            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span>${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)</span>
                    <span class="remove-file" onclick="removeFile(${index})">Remove</span>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            displayFiles();
        }

        // Phone number formatting
        document.querySelectorAll('input[type="tel"]').forEach(input => {
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 0) {
                    if (value.length <= 4) {
                        value = value;
                    } else if (value.length <= 7) {
                        value = value.slice(0, 4) + ' ' + value.slice(4);
                    } else {
                        value = value.slice(0, 4) + ' ' + value.slice(4, 7) + ' ' + value.slice(7, 10);
                    }
                }
                e.target.value = value;
            });
        });

        // Form validation and submission
        const form = document.getElementById('referralForm');
        const formContainer = document.querySelector('.form-container');
        const loadingContainer = document.querySelector('.loading');
        const successContainer = document.querySelector('.success-container');

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Check verification first (silently reject if needed)
            if (verifySubmission()) {
                // Show success but don't actually submit
                formContainer.style.display = 'none';
                successContainer.style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }
            
            // Validate form
            let isValid = true;
            const requiredFields = form.querySelectorAll('[required]');
            
            // Check location selection
            const locationSelected = form.querySelector('input[name="location"]:checked');
            if (!locationSelected) {
                const locationError = form.querySelector('input[name="location"]').closest('.form-group').querySelector('.error');
                locationError.style.display = 'block';
                isValid = false;
            }
            
            requiredFields.forEach(field => {
                if (field.type === 'radio') return; // Skip radio buttons, handled separately
                const errorSpan = field.parentElement.querySelector('.error');
                if (!field.value.trim()) {
                    errorSpan.style.display = 'block';
                    isValid = false;
                } else {
                    errorSpan.style.display = 'none';
                }
            });

            // Validate email formats
            const emailFields = form.querySelectorAll('input[type="email"]');
            emailFields.forEach(field => {
                const errorSpan = field.parentElement.querySelector('.error');
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (field.value && !emailRegex.test(field.value)) {
                    errorSpan.style.display = 'block';
                    errorSpan.textContent = 'Please enter a valid email address';
                    isValid = false;
                }
            });

            // Validate phone numbers
            const phoneFields = form.querySelectorAll('input[type="tel"]');
            phoneFields.forEach(field => {
                const errorSpan = field.parentElement.querySelector('.error');
                const phoneValue = field.value.replace(/\D/g, '');
                if (phoneValue.length !== 10) {
                    errorSpan.style.display = 'block';
                    errorSpan.textContent = 'Please enter a valid 10-digit phone number';
                    isValid = false;
                }
            });

            // Validate Medicare number
            const medicareField = document.getElementById('medicareNumber');
            const medicareError = medicareField.parentElement.querySelector('.error');
            const medicareValue = medicareField.value.replace(/\s/g, '');
            if (medicareValue.length < 10 || medicareValue.length > 11) {
                medicareError.style.display = 'block';
                medicareError.textContent = 'Please enter a valid Medicare number';
                isValid = false;
            }

            if (!isValid) return;

            // Show loading state
            formContainer.style.display = 'none';
            loadingContainer.style.display = 'block';

            // Prepare form data
            const formData = new FormData(form);
            
            // Add files to form data
            uploadedFiles.forEach((file, index) => {
                formData.append(`file_${index}`, file);
            });

            try {
                // Convert date format from DD/MM/YYYY to YYYY-MM-DD for Power Automate
                const dobValue = document.getElementById('patientDOB').value;
                const dobParts = dobValue.split('/');
                const formattedDOB = `${dobParts[2]}-${dobParts[1]}-${dobParts[0]}`;
                
                // Convert Medicare expiry from MM/YYYY to YYYY-MM
                const expiryValue = document.getElementById('medicareExpiry').value;
                const expiryParts = expiryValue.split('/');
                const formattedExpiry = `${expiryParts[1]}-${expiryParts[0]}`;
                
                // Prepare the data for Power Automate
                const powerAutomateData = {
                    Location: document.querySelector('input[name="location"]:checked').value,
                    DoctorName: document.getElementById('doctorName').value,
                    DoctorPractice: document.getElementById('doctorPractice').value,
                    DoctorEmail: document.getElementById('doctorEmail').value,
                    DoctorPhone: document.getElementById('doctorPhone').value,
                    PatientName: document.getElementById('patientName').value,
                    PatientDOB: formattedDOB,
                    PatientPhone: document.getElementById('patientPhone').value,
                    PatientEmail: document.getElementById('patientEmail').value,
                    MedicareNumber: document.getElementById('medicareNumber').value,
                    MedicarePosition: document.getElementById('medicarePosition').value,
                    MedicareExpiry: formattedExpiry,
                    ReferralReason: document.getElementById('referralReason').value,
                    SubmittedAt: new Date().toISOString(),
                    FormVersion: '2.0-secure'
                };

                // Send to Power Automate
                const response = await fetch('https://default305a0450892a49869dc365362e210f.c0.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/54f351d3da10493f875c1e02d572bf62/triggers/manual/paths/invoke/?api-version=1&tenantId=tId&environmentId=Default-305a0450-892a-4986-9dc3-65362e210fc0&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=cnJhKQeh4p4EyWddfFR-KcPJAF5DFxV_-qjvG8eBL-A', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(powerAutomateData)
                });

                if (!response.ok) {
                    throw new Error('Submission failed');
                }

                // Show success state
                loadingContainer.style.display = 'none';
                successContainer.style.display = 'block';
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (error) {
                console.error('Submission error:', error);
                
                // Hide loading, show form again
                loadingContainer.style.display = 'none';
                formContainer.style.display = 'block';
                
                // Show detailed error message
                const errorContainer = document.createElement('div');
                errorContainer.className = 'error-container';
                errorContainer.innerHTML = `
                    <div class="error-box">
                        <h3 style="color: #c95a28; margin-bottom: 15px;">‚ö†Ô∏è Submission Error</h3>
                        <p style="margin-bottom: 15px;">We're sorry, but we couldn't submit your referral. This might be a temporary issue with our system.</p>
                        
                        <div class="error-details">
                            <p><strong>What you can do:</strong></p>
                            <ul style="margin: 10px 0 20px 20px;">
                                <li>Try submitting again in a few moments</li>
                                <li>Contact us directly using the details below</li>
                                <li>Email the referral to us</li>
                            </ul>
                        </div>
                        
                        <div class="contact-box" style="background: #f5e7cc; padding: 20px; border-radius: 12px; margin: 20px 0;">
                            <h4 style="margin-bottom: 10px;">Contact Us Directly:</h4>
                            <p>üìû Phone: <a href="tel:0242280033" style="color: #c95a28;">02 4228 0033</a></p>
                            <p>üìß Email: <a href="mailto:admin@placepsychology.com.au" style="color: #c95a28;">admin@placepsychology.com.au</a></p>
                            <p>üåê Website: <a href="https://placepsychology.com.au" target="_blank" style="color: #c95a28;">placepsychology.com.au</a></p>
                        </div>
                        
                        <div class="error-actions" style="display: flex; gap: 15px; margin-top: 20px;">
                            <button onclick="window.location.reload()" class="retry-button" style="padding: 12px 24px; background: #d66f2a; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Try Again
                            </button>
                            <button onclick="reportIssue()" class="report-button" style="padding: 12px 24px; background: #a9d0c6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Report This Issue
                            </button>
                        </div>
                        
                        <details style="margin-top: 20px;">
                            <summary style="cursor: pointer; color: #666;">Technical Details (for IT support)</summary>
                            <pre style="background: #f5f5f5; padding: 10px; margin-top: 10px; font-size: 12px; overflow-x: auto;">${error.message || 'Connection failed'}</pre>
                        </details>
                    </div>
                `;
                
                // Insert error message at top of form
                formContainer.insertBefore(errorContainer, formContainer.firstChild);
                
                // Scroll to error message
                errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Log error details for debugging
                const errorData = {
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    formData: {
                        location: document.querySelector('input[name="location"]:checked')?.value,
                        doctorName: document.getElementById('doctorName').value,
                        patientName: document.getElementById('patientName').value
                    },
                    error: error.message || 'Unknown error'
                };
                console.log('Error details for support:', errorData);
            }
        });

        // Prevent accidental form resubmission on page refresh
        if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.href);
        }

        // Function to report issues
        function reportIssue() {
            const errorDetails = {
                page: 'Referral Form',
                timestamp: new Date().toISOString(),
                browser: navigator.userAgent,
                formData: {
                    doctorName: document.getElementById('doctorName').value || 'Not provided',
                    practiceName: document.getElementById('doctorPractice').value || 'Not provided'
                }
            };
            
            const subject = encodeURIComponent('Referral Form Error Report');
            const body = encodeURIComponent(`
Dear Place Psychology IT Support,

I encountered an error while trying to submit a patient referral through your online form.

Error Details:
- Time: ${errorDetails.timestamp}
- Doctor: ${errorDetails.formData.doctorName}
- Practice: ${errorDetails.formData.practiceName}
- Browser: ${errorDetails.browser}

Please assist with this issue as soon as possible.

Thank you
            `);
            
            window.location.href = `mailto:admin@placepsychology.com.au?subject=${subject}&body=${body}`;
        }

        // Test connection function
        async function testConnection() {
            const testResult = document.getElementById('testResult');
            testResult.innerHTML = '<span style="color: #d66f2a;">Testing connection...</span>';
            
            try {
                const testData = {
                    Location: 'test',
                    DoctorName: 'TEST - Connection Test',
                    DoctorPractice: 'TEST',
                    DoctorEmail: 'test@test.com',
                    DoctorPhone: '0000000000',
                    PatientName: 'TEST PATIENT - DELETE',
                    PatientDOB: '2000-01-01',
                    PatientPhone: '0000000000',
                    PatientEmail: 'test@test.com',
                    MedicareNumber: '0000000000',
                    MedicarePosition: '1',
                    MedicareExpiry: '2025-12',
                    ReferralReason: 'CONNECTION TEST - PLEASE DELETE THIS ENTRY',
                    SubmittedAt: new Date().toISOString(),
                    FormVersion: '2.0-secure'
                };
                
                const response = await fetch('https://default305a0450892a49869dc365362e210f.c0.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/54f351d3da10493f875c1e02d572bf62/triggers/manual/paths/invoke/?api-version=1&tenantId=tId&environmentId=Default-305a0450-892a-4986-9dc3-65362e210fc0&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=cnJhKQeh4p4EyWddfFR-KcPJAF5DFxV_-qjvG8eBL-A', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                if (response.ok) {
                    testResult.innerHTML = '<span style="color: #4CAF50;">‚úÖ Connection successful! Check SharePoint for test entry.</span>';
                } else {
                    testResult.innerHTML = `<span style="color: #c95a28;">‚ùå Connection failed: ${response.status} ${response.statusText}</span>`;
                }
            } catch (error) {
                testResult.innerHTML = `<span style="color: #c95a28;">‚ùå Connection error: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>
